# About

This repository contains Docker Compose files for running a Bitcoin and/or a
Monero node inside a container, including - if desired - VPN configuration
(wireguard) to hide the IP address of the nodes.

- [About](#about)
- [Requirements](#requirements)
- [Docker Compose Files](#docker-compose-files)
- [Option 1: Nodes without VPN](#option-1-nodes-without-vpn)
	- [Configure](#configure)
	- [Firewall Configuration](#firewall-configuration)
	- [1. Run from CLI](#1-run-from-cli)
	- [2. Run in background (systemd)](#2-run-in-background-systemd)
- [Option 2: Nodes with VPN Setup](#option-2-nodes-with-vpn-setup)
	- [Configure](#configure-1)
	- [Setup VPN Server](#setup-vpn-server)
		- [Key generation](#key-generation)
		- [Client Configuration](#client-configuration)
	- [Server Configuration](#server-configuration)
	- [Execution](#execution)

![Networking VPN Diagram](./assets/networking_vpn_diagram.svg)

# Requirements

* Docker Compose
* For VPN configuration, either a commercial service or a custom VPS.

# Docker Compose Files

This repo contains two Docker Compose files, depending on whether a VPN
connection should be established or not.

* `docker-compose.nodes-no-vpn.yml`
* `docker-compose.nodes-with-vpn.yml`

Be default, all the (persistent) data generated by `bitcoind` and `monerod` (and
`wireguard` VPN) is saved to `./mounts`. This includes blochain data, states and
other configuration files.

# Option 1: Nodes without VPN

## Configure

Copy the appropriate file (`*.nodes-no-vpn.*`) and give it a name:

```bash
$ cp docker-compose.nodes-no-vpn.yml my-setup.yml
```

Then open the file and adjust the `CLI_ARGS` environment variable according to
you needs. Those arguments are passed on directly to `bitcoind` and `monerdo`,
respectively. Those arguments are application specific and not documented here.

This is the only thing you need to adjust (marked `"ADJUST"`). You're free to
change mount options, etc.

## Firewall Configuration

Update the firewall rules accordingly:

```console
# VPN port
$ sudo ufw allow in 51820
# Bitcoin port
$ sudo ufw allow in 8333
# Monero port
$ sudo ufw allow in 18080
```

## 1. Run from CLI

To run the Docker Compose file:

* Run a Bitcoin node only:
	```console
	$ docker compose -f my-setup.yml --profile bitcoin up
	```
* Run a Monero node only:
	```console
	$ docker compose -f my-setup.yml --profile monero up
	```
* Run both a Bitcoin and a Monero node:
	```console
	$ docker compose -f my-setup.yml --profile bitcoin --profile monero up
	```

That's it, you're done. You might want to run this in `tmux` so you can detach
and logout of the machine, for example. Alternatively, see [Run in background
(systemd)](#run-in-background-systemd)

## 2. Run in background (systemd)

TODO

# Option 2: Nodes with VPN Setup

## Configure

Copy the appropriate file (`*.nodes-with-vpn.*`) and give it a name:

```bash
$ cp docker-compose.nodes-with-vpn.yml my-setup.yml
```

Then open the file and adjust the `CLI_ARGS` environment variable according to
you needs. Those arguments are passed on directly to `bitcoind` and `monerdo`,
respectively. Those arguments are application specific and not documented here.
The networking IP assignments should work out of the box, unless you already use
the `10.50.0.0/24` subnet for other networks. Adjust it accordingly (remember to
specify those IP addresses in the VPN server configuration).

This is the only thing you need to adjust (marked `"ADJUST"`). You're free to
change mount options, etc.

## Setup VPN Server

**NOTE**: You can use a commercial VPN service that supports wireguard for this
setup that also provides the encryption keys for you. However, you will need to
forward ports to your nodes and often the commercial service chooses the port
numbers for you, not giving you much flexibility. As a result, you must
configure the ports in the Docker Compose file accordingly. In case you're using
a commercial service, continue with [Setup Nodes with VPN
Connection](#setup-nodes-with-vpn-connection).

### Key generation

You need to generate a private/public keypair for both the client and the
server, use the `wg` CLI tool. For example:

```console
$ sudo apt install wireguard
$ wg genkey
YGBDCJe2FwuIE53VW7UnFKpenOnKAhhFlYm//4ufVHU=
$ echo 'YGBDCJe2FwuIE53VW7UnFKpenOnKAhhFlYm//4ufVHU=' | wg pubkey
OyBsjeFKQASaV14UX5SZWPaH0GC7z9G89fx3pmOX1xg=
```

(Do not use those example keys for your setup, generate your own)

### Client Configuration

Use the template file in `./mounts/wireguard/` and rename it to `wg0.conf`. The
wireguard container will mount that volume and use that configuration.

```console
$ cp ./mounts/wireguard/wg0.conf.template ./mounts/wireguard/wg0.conf
```

Then adjust it accordingly:

```ini
# Client
[Interface]
PrivateKey = <PRIVATE-KEY>
Address = 10.50.0.50/32

# VPN Server
[Peer]
PublicKey = <PUBLIC-KEY>
AllowedIPs = 0.0.0.0/0
# Public VPN Endpoint
Endpoint = <IP-ADDRESS>:51820
```

Do note that you don't need to open any ports on your client, given that
everything is routed through the VPN network.

## Server Configuration

On the VPN server, enable packet forwarding for IPv4 by opening the following
file:

```console
$ sudo vim /etc/sysctl.conf
```

Then set the following line to `1`:

```console
net.ipv4.ip_forward=1
```

Reload values:

```console
$ sudo sysctl -p
```

Then create the config file `/etc/wireguard/wg0.conf`. Depending on your
configuration, you might need to update the internal IP addresses, ports, etc..
Also, please **check the network interface**: your VPN servers network interface
to the internet might not be called `eth0`. Adjust it accordingly by checking:

```console
$ ip link
```

The configuration file:

```ini
[Interface]
# Make sure this matches the `Endpoint` in the clients `wg0.conf`.
ListenPort = 51820
PrivateKey = <PRIVATE-KEY>
#
# Allow forwarding from the VPN network (to the internet)
PostUp = iptables -A FORWARD -i wg0 -j ACCEPT
# Enable NAT/masquerading when accessing internet
PostUp = iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
# Allow forwarding from the internet (to the VPN network)
PostUp = iptables -A FORWARD -i eth0 -j ACCEPT
#
# Forward ports to clients
# Bitcoin:
PostUp = iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 8333 -j DNAT --to-destination 10.50.0.20:8333
# Monero:
PostUp = iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 18080 -j DNAT --to-destination 10.50.0.22:18080
#
## DROP rules, just the reverse of the above
PostDown = iptables -D FORWARD -i wg0 -j ACCEPT;
PostDown = iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE
PostDown = iptables -D FORWARD -i eth0 -j ACCEPT
PostDown = iptables -t nat -D PREROUTING -i eth0 -p tcp --dport 8333 -j DNAT --to-destination 10.50.0.20:8333
PostDown = iptables -t nat -D PREROUTING -i eth0 -p tcp --dport 18080 -j DNAT --to-destination 10.50.0.22:18080

[Peer]
PublicKey = <PUBLIC-KEY>
AllowedIPs = 10.50.0.0/24
```

Then add update the servers firewall rules accordingly (note that you do not
have to do this on the client):

```console
# VPN port
$ sudo ufw allow in 51820
# Bitcoin port
$ sudo ufw allow in 8333
# Monero port
$ sudo ufw allow in 18080
```

Now start the wireguard VPN:

```bash
$ sudo wg-quick up wg0
# Enable on startup:
$ sudo systemctl enable wg-quick@wg0.service
```

## Execution

Same commands as for the [non-VPN setup](#1-run-from-cli).
