# About

This repository contains Docker Compose files for running a Bitcoin and/or a
Monero node inside a container, including - if desired - VPN configuration
(wireguard) to hide the IP address of the nodes.

- [About](#about)
- [Requirements](#requirements)
- [Docker Compose Files](#docker-compose-files)
- [Option 1: Nodes without VPN](#option-1-nodes-without-vpn)
	- [Configure](#configure)
	- [1. Run from CLI](#1-run-from-cli)
	- [2. Run in background (systemd)](#2-run-in-background-systemd)
- [Option 2: Nodes with VPN Setup](#option-2-nodes-with-vpn-setup)
	- [Setup VPN Server](#setup-vpn-server)
	- [Setup Nodes with VPN Connection](#setup-nodes-with-vpn-connection)
- [VPN Server](#vpn-server)

![Networking VPN Diagram](./assets/networking_vpn_diagram.svg)

# Requirements

* Docker Compose
* For VPN configuration, either a commercial service or a custom VPS.

# Docker Compose Files

This repo contains two Docker Compose files, depending on whether a VPN
connection should be established or not.

* `docker-compose.nodes-no-vpn.yml`
* `docker-compose.nodes-with-vpn.yml`

Be default, all the (persistent) data generated by `bitcoind` and `monerod` (and
`wireguard` VPN) is saved to `./mounts`. This includes blochain data, states and
other configuration files.

# Option 1: Nodes without VPN

## Configure

Copy the appropriate file (`*.nodes-no-vpn.*`) and give it a name:

```bash
cp docker-compose.nodes-no-vpn.yml my-setup.yml
```

Then open the file and adjust the `CLI_ARGS` environment variable according to
you needs. Those arguments are passed on directly to `bitcoind` and `monerdo`,
respectively. Those arguments are application specific and not documented here.

This is the only thing you need to adjust (marked `"ADJUST"`). You're free to
change mount options, etc.

## 1. Run from CLI

To run the Docker Compose file:

* Run a Bitcoin node only:
	```bash
	docker compose -f my-setup.yml --profile bitcoin up
	```
* Run a Monero node only:
	```bash
	docker compose -f my-setup.yml --profile monero up
	```
* Run both a Bitcoin and a Monero node:
	```bash
	docker compose -f my-setup.yml --profile bitcoin --profile monero up
	```

That's it, you're done. You might want to run this in `tmux` so you can detach
and logout of the machine, for example. Alternatively, see [Run in background
(systemd)](#run-in-background-systemd)

## 2. Run in background (systemd)

TODO

# Option 2: Nodes with VPN Setup

## Setup VPN Server

**NOTE**: You can use a commercial VPN service that supports wireguard for this setup.
However, you will need to forward ports to your nodes and often the commercial
service chooses the port numbers for you, not giving you much flexibility. As a
result, you must configure the ports in the Docker Compose file accordingly. In
case you're using a commercial service, continue with [Setup Nodes with VPN
Connection](#setup-nodes-with-vpn-connection).



## Setup Nodes with VPN Connection

```ini
# Client
[Interface]
PrivateKey = <PRIVATE-KEY>
Address = 10.50.0.50/32

# VPN Server
[Peer]
PublicKey = <PUBLIC-KEY>
AllowedIPs = 0.0.0.0/0
# Public VPN Endpoint
Endpoint = <IP-ADDRESS>:51820
```

# VPN Server

sudo nano /etc/sysctl.conf
sudo sysctl -p

sudo iptables -A FORWARD -i wg0 -j ACCEPT
sudo iptables -t nat -A POSTROUTING -o ens4 -j MASQUERADE

Add config to `/etc/wireguard/wg0.conf`:

```ini
[Interface]
ListenPort = 51820
PrivateKey = <PRIVATE-KEY>
#
# Allow forwarding from the VPN network (to the internet)
PostUp = iptables -A FORWARD -i wg0 -j ACCEPT
# Enable NAT/masquerading when accessing internet
PostUp = iptables -t nat -A POSTROUTING -o ens4 -j MASQUERADE
# Allow forwarding from the internet (to the VPN network)
PostUp = iptables -A FORWARD -i ens4 -j ACCEPT
#
# Forward port 8000 to client
PostUp = iptables -t nat -A PREROUTING -i ens4 -p tcp --dport 8000 -j DNAT --to-destination 10.50.0.20:8000
#
## DROP rules, just the reverse of the above
PostDown = iptables -D FORWARD -i wg0 -j ACCEPT;
PostDown = iptables -t nat -D POSTROUTING -o ens4 -j MASQUERADE
PostDown = iptables -D FORWARD -i ens4 -j ACCEPT
PostDown = iptables -t nat -D PREROUTING -i ens4 -p tcp --dport 8000 -j DNAT --to-destination 10.50.0.20:8000

[Peer]
PublicKey = <PUBLIC-KEY>
AllowedIPs = 10.50.0.0/24
```

Then:

```bash
sudo wg-quick up wg0
# (Optional) Enable on startup:
sudo systemctl enable wg-quick@wg0.service
```
